apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      allowEmpty: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 55.5.0
    helm:
      releaseName: prometheus-stack
      values: |
        hostRootFsMount:
          enabled: false
          mountPropagation: HostToContainer
        alertmanager:
          enabled: true
          fullnameOverride: alertmanager
          ingress:
            enabled: false
        coreDns:
          enabled: true
        defaultRules:
          create: true
          rules:
            alertmanager: true
            configReloaders: true
            etcd: true
            general: true
            k8s: true
            kubeApiserverAvailability: true
            kubeApiserverBurnrate: true
            kubeApiserverHistogram: true
            kubeApiserverSlos: true
            kubePrometheusGeneral: true
            kubePrometheusNodeRecording: true
            kubeProxy: true
            kubeScheduler: true
            kubeStateMetrics: true
            kubelet: true
            kubernetesApps: true
            kubernetesResources: true
            kubernetesStorage: true
            kubernetesSystem: true
            network: true
            node: true
            nodeExporterAlerting: true
            nodeExporterRecording: true
            prometheus: true
            prometheusOperator: true
        fullnameOverride: prometheus
        grafana:
          admin:
            existingSecret: grafana-admin-credentials
            passwordKey: admin-password
            userKey: admin-user
          defaultDashboardsEnabled: true
          defaultDashboardsTimezone: utc
          enabled: true
          forceDeployDashboards: false
          forceDeployDatasources: false
          fullnameOverride: grafana
          serviceMonitor:
            enabled: true
        kube-state-metrics:
          fullnameOverride: kube-state-metrics
          prometheus:
            monitor:
              enabled: true
              relabelings:
                - action: replace
                  regex: (.*)
                  replacement: $1
                  sourceLabels:
                    - __meta_kubernetes_pod_node_name
                  targetLabel: kubernetes_node
          selfMonitor:
            enabled: true
        kubeApiServer:
          enabled: true
        kubeEtcd:
          enabled: true
          service:
            targetPort: 2381
        kubeControllerManager:
          enabled: true
          service:
            targetPort: 10257
        kubeScheduler:
          service:
            targetPort: 10259
        kubeDns:
          enabled: false
        kubeProxy:
          enabled: true
        kubeScheduler:
          enabled: true
        kubeStateMetrics:
          enabled: true
        kubelet:
          enabled: true
          serviceMonitor:
            metricRelabelings:
              - action: replace
                sourceLabels:
                  - node
                targetLabel: instance
        nodeExporter:
          enabled: true
          serviceMonitor:
            relabelings:
              - action: replace
                regex: (.*)
                replacement: $1
                sourceLabels:
                  - __meta_kubernetes_pod_node_name
                targetLabel: kubernetes_node
        prometheus:
          enabled: true
          prometheusSpec:
            enableAdminAPI: true
            podMonitorSelectorNilUsesHelmValues: false
            probeSelectorNilUsesHelmValues: false
            replicaExternalLabelName: replica
            replicas: 1
            retention: 6h
            ruleSelectorNilUsesHelmValues: false
            walCompression: true
            serviceMonitorSelectorNilUsesHelmValues: true
            serviceMonitorSelector: 
              matchLabels:
                release: prometheus-stack
            serviceMonitorNamespaceSelector: {}
            additionalScrapeConfigs:
              - job_name: minio-job
                bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoic2hlLWFkbWluIiwiZXhwIjo0ODU3NTU5MzM1fQ.3ExG3b-sPHJxaReZb_0zgrJkuGCeN2prk_OpOtw-0E2h3ICpCRfqA3dCIK8-0DSObyjGWm8rV6OVUeq1bRXTyw
                metrics_path: /minio/v2/metrics/cluster
                scheme: http
                static_configs:
                - targets: ['minio.minio.svc:9000']
              - job_name: minio-job-node
                bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoic2hlLWFkbWluIiwiZXhwIjo0ODU3NTU5Mzk1fQ.3rnGy7IIl5X6RtU8HSWHEGDiwJQdXsXyeC1nVlrFB62wLGJkvI-evXphYF2wlaq89MsiDgiGSrz-Fja-cWJu5g
                metrics_path: /minio/v2/metrics/node
                scheme: http
                static_configs:
                - targets: ['minio.minio.svc:9000']
              - job_name: minio-job-bucket
                bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoic2hlLWFkbWluIiwiZXhwIjo0ODU3NTU5NDI3fQ.OwJxOSvzXyoPv1VcyfjM1N_GVICU-B35AofNabzYBhwCI6UKcyI1ucvQS1RILOHMA0z7dLOg1CR7ZZdNvUC9_g
                metrics_path: /minio/v2/metrics/bucket
                scheme: http
                static_configs:
                - targets: ['minio.minio.svc:9000']
              - job_name: minio-job-resource
                bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoic2hlLWFkbWluIiwiZXhwIjo0ODU3NTU5NDU5fQ.AAj3zoYZXhPQf_o_EA2g2jVHrIeBugiQu6op1e3a2QcdqRMmZc6qIw0aAYYEGunbUEtZOBCvche3kvErjcbCdQ
                metrics_path: /minio/v2/metrics/resource
                scheme: http
                static_configs:
                - targets: ['minio.minio.svc:9000']
              - job_name: 'crunchy-postgres-exporter'
                kubernetes_sd_configs:
                - role: pod
                relabel_configs:
                - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_crunchy_postgres_exporter,__meta_kubernetes_pod_label_crunchy_postgres_exporter]
                  action: keep
                  regex: true
                  separator: ""
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: drop
                  regex: 5432
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: drop
                  regex: 10000
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: drop
                  regex: 8009
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: drop
                  regex: 2022
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: drop
                  regex: ^$
                - source_labels: [__meta_kubernetes_namespace]
                  action: replace
                  target_label: kubernetes_namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_cluster,__meta_kubernetes_pod_label_pg_cluster]
                  target_label: cluster
                  separator: ""
                  replacement: '$1'
                - source_labels: [__meta_kubernetes_namespace,cluster]
                  target_label: pg_cluster
                  separator: ":"
                  replacement: '$1$2'
                - source_labels: [__meta_kubernetes_pod_ip]
                  target_label: ip
                  replacement: '$1'
                - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_instance,__meta_kubernetes_pod_label_deployment_name]
                  target_label: deployment
                  replacement: '$1'
                  separator: ""
                - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_role,__meta_kubernetes_pod_label_role]
                  target_label: role
                  replacement: '$1'
                  separator: ""
        prometheus-node-exporter:
          extraArgs:
            - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
            - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$
          fullnameOverride: node-exporter
          podLabels:
            jobLabel: node-exporter
          prometheus:
            monitor:
              enabled: true
              relabelings:
                - action: replace
                  regex: (.*)
                  replacement: $1
                  sourceLabels:
                    - __meta_kubernetes_pod_node_name
                  targetLabel: kubernetes_node
          resources:
            limits:
              memory: 2048Mi
            requests:
              cpu: 250m
              memory: 512Mi
          service:
            portName: http-metrics
        prometheusOperator:
          enabled: true
          prometheusConfigReloader:
            resources:
              limits:
                memory: 100Mi
              requests:
                cpu: 200m
                memory: 50Mi
        thanosRuler:
          enabled: false
